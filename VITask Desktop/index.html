<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    VITask
  </title>
  <meta content='width=device-width, initial-scale=1.0, shrink-to-fit=no' name='viewport' />
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <!-- CSS Files -->
  <link href="assets/css/material-kit.css?v=2.0.7" rel="stylesheet" />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="assets/demo/demo.css" rel="stylesheet" />
    <style>
    #loading {
    cursor: wait;
    display: flex;
    flex-direction: row;
    flex-wrap: wrap;
    justify-content: center;
    align-items: center;
    }
    #svgload{
    width: 120px; 
    }
    </style>
</head>

<body class="login-page sidebar-collapse">
  
  <div class="page-header header-filter" style="background-image: url('assets/img/bg7.jpg'); background-size: cover; background-position: top center;">
    <div class="container">
      <div class="row">
        <div class="col-lg-4 col-md-6 ml-auto mr-auto">
            
          <div id="loading">
                <svg id="svgload" version="1.1" id="preloader" x="0px" y="0px" width="240px" height="120px" viewBox="0 0 240 120">

                    <style type="text/css" >
                        <![CDATA[

                            #plug,
                            #socket { fill:#FFFFFF }

                            #loop-normal { fill: none; stroke: #FFFFFF; stroke-width: 12 }
                            #loop-offset { display: none }

                        ]]>
                    </style>

                    <path id="loop-normal" class="st1" d="M120.5,60.5L146.48,87.02c14.64,14.64,38.39,14.65,53.03,0s14.64-38.39,0-53.03s-38.39-14.65-53.03,0L120.5,60.5
                    L94.52,87.02c-14.64,14.64-38.39,14.64-53.03,0c-14.64-14.64-14.64-38.39,0-53.03c14.65-14.64,38.39-14.65,53.03,0z">
                        <animate attributeName="stroke-dasharray" attributeType="XML"
                            from="500, 50"  to="450 50"
                            begin="0s" dur="2s"
                            repeatCount="indefinite"/>
                        <animate attributeName="stroke-dashoffset" attributeType="XML"
                            from="-40"  to="-540"
                            begin="0s" dur="2s"
                            repeatCount="indefinite"/>  
                    </path>

                    <path id="loop-offset" d="M146.48,87.02c14.64,14.64,38.39,14.65,53.03,0s14.64-38.39,0-53.03s-38.39-14.65-53.03,0L120.5,60.5
                    L94.52,87.02c-14.64,14.64-38.39,14.64-53.03,0c-14.64-14.64-14.64-38.39,0-53.03c14.65-14.64,38.39-14.65,53.03,0L120.5,60.5
                    L146.48,87.02z"/>

                    <path id="socket" d="M7.5,0c0,8.28-6.72,15-15,15l0-30C0.78-15,7.5-8.28,7.5,0z"/>  

                    <path id="plug" d="M0,9l15,0l0-5H0v-8.5l15,0l0-5H0V-15c-8.29,0-15,6.71-15,15c0,8.28,6.71,15,15,15V9z"/>

                    <animateMotion
                        xlink:href="#plug"
                        dur="2s"
                        rotate="auto"
                        repeatCount="indefinite"
                        calcMode="linear"
                        keyTimes="0;1"    
                        keySplines="0.42, 0, 0.58, 1">
                        <mpath xlink:href="#loop-normal"/>
                    </animateMotion>

                    <animateMotion             
                        xlink:href="#socket"
                        dur="2s"
                        rotate="auto"
                        repeatCount="indefinite"
                        calcMode="linear"
                        keyTimes="0;1"
                        keySplines="0.42, 0, 0.58, 1">
                        <mpath xlink:href="#loop-offset"/>
                    </animateMotion>  
                </svg>

                <br>
                <div class="row justify-content-center">
                    <div class="col-lg-5 col-md-6">
                      <p class="text-lead text-white" id="progress" style="font-weight: 600;"></p>
                    </div>
                </div>
            </div>
            
          <div class="card card-login" id="content">
            <form class="form" method="">
              <div class="card-header card-header-primary text-center">
                <h4 class="card-title"><img src="assets/img/icon.png" style="height: 100%; width: 100%; object-fit: contain"></h4>
                <div class="social-line">
                  <p>One-click Integration</p>
                </div>
              </div>
              <p class="description text-center">Powered by Magical Elixir ;)</p>
              <div class="card-body">
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text">
                      <i class="material-icons">mood</i>
                    </span>
                  </div>
                  <input type="text" class="form-control" placeholder="Registration Number" id="regno" required>
                </div>
                <div class="input-group">
                  <div class="input-group-prepend">
                    <span class="input-group-text">
                      <i class="material-icons">lock_outline</i>
                    </span>
                  </div>
                  <input type="password" class="form-control" placeholder="Password" id="password" required>
                </div>
              </div>
              <div class="footer text-center">
                  <a class="btn btn-danger" id="signin" onclick="login();">Login</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    <footer class="footer">
      <div class="container">
    
      </div>
    </footer>
  </div>

    
    <script>
            const electron =  require('electron');
            const Store = require('electron-store');
            const request = require('request');
            window.$ = window.jQuery = require('jquery');
            const Datastore = require('nedb');
            var data = new Datastore({ filename: 'dashboard/userdata/data.db', autoload: true });
            const {ipcRenderer} = electron;
            const remote = electron.remote
            
            function done(token)
                {
                    console.log('Found user:', token);
                        
                    var window = remote.getCurrentWindow();
                    window.close();
                }
            
        
            $(document).ready(function() {
                $("#loading").fadeOut();

                data.findOne({ profile: 'user-profile' }, function(err, doc) { 
                    if(doc != null)
                        {
                            ipcRenderer.send('login:new','loggedin');
                            done(doc.APItoken);
                        }
                    
                });
                
            })
            
        
            function login(){
                let regno = document.getElementById("regno").value.toUpperCase();
                let password = document.getElementById("password").value;
                let url = 'http://134.209.150.24/api/gettoken';
                let timetable_ini_url = 'http://134.209.150.24/api/vtop/timetable'
                let acadhistory_ini_url = 'http://134.209.150.24/api/vtop/history'
                let attendance_ini_url = 'http://134.209.150.24/api/vtop/attendance'
                let marks_ini_url = 'http://134.209.150.24/api/vtop/marks'
                
                $("#loading").show();
                $("#content").hide(); 
                $("#progress").html("Authenticating...").show().delay(7000).fadeOut( function() {
                    $("#progress").html("Almost done...").fadeIn();
                    });
            
                
                request({
                    headers: {
                      'Content-Type': 'application/json; charset=UTF-8',
                      'X-VITASK-API': '98e1e33a8e1964f073d2cc7a5c6bea755e862fe0e9041822e476d3b5b089a6a94f8343faf7b475c54cb1f490b762b8563144b64a914e06d421f8eed9d040ddd2'
                    },
                    uri: url,
                    json: true,
                    body: {"username" : regno,"password" : password},
                    method: 'POST'
                  }, function (err, res, body) {
                        if(err){
                        console.log('error:', err);
                      } else {
                        let result = body;
                        if(result.error){
                            $("#loading").fadeOut();
                            $("#content").fadeIn(); 
                            alert("Wrong Password.");
                        }
                        else{
                        result.profile = "user-profile";
                        result.regno = regno;
                        result.password = password;

                        data.insert(result, function(err, doc) {
                        console.log('Inserted', doc.Name);
                            timetable(doc.APItoken, function() {
                                    acadhistory(doc.APItoken, function(){
                                        marks(doc.APItoken, function(){
                                            attendance(doc.APItoken, function(){
                                                ipcRenderer.send('login:new','loggedin');
                                                done(doc.APItoken);
                                            });
                                        });
                                    });
                                });
                        });

                        
                        }
                    } 
                });

                
                function timetable(token, callback){
                    request({
                        headers: {
                          'Content-Type': 'application/json; charset=UTF-8',
                          'X-VITASK-API': '98e1e33a8e1964f073d2cc7a5c6bea755e862fe0e9041822e476d3b5b089a6a94f8343faf7b475c54cb1f490b762b8563144b64a914e06d421f8eed9d040ddd2'
                        },
                        uri: timetable_ini_url,
                        json: true,
                        body: {"token" : token},
                        method: 'POST'
                      }, function (err, response, body) {
                          if(err){
                            console.log('error:', err);
                          } else {
                            let result = body;
                            result.tt = "user-timetable";

                            data.insert(result, function(err, doc) {
                            console.log('Inserted', doc.timetable);
                            callback();
                            });
                          }
                    });
                    
                }
                
                function acadhistory(token, callback){
                    request({
                        headers: {
                          'Content-Type': 'application/json; charset=UTF-8',
                          'X-VITASK-API': '98e1e33a8e1964f073d2cc7a5c6bea755e862fe0e9041822e476d3b5b089a6a94f8343faf7b475c54cb1f490b762b8563144b64a914e06d421f8eed9d040ddd2'
                        },
                        uri: acadhistory_ini_url,
                        json: true,
                        body: {"token" : token},
                        method: 'POST'
                      }, function (err, response, body) {
                          if(err){
                            console.log('error:', err);
                          } else {
                            let result = body;
                            result.acad = "user-acadhistory";

                            data.insert(result, function(err, doc) {
                            console.log('Inserted', doc.acadHistory);
                            callback();
                            });
                          }
                    });
                    
                }
                
                function marks(token, callback){
                    request({
                        headers: {
                          'Content-Type': 'application/json; charset=UTF-8',
                          'X-VITASK-API': '98e1e33a8e1964f073d2cc7a5c6bea755e862fe0e9041822e476d3b5b089a6a94f8343faf7b475c54cb1f490b762b8563144b64a914e06d421f8eed9d040ddd2'
                        },
                        uri: marks_ini_url,
                        json: true,
                        body: {"token" : token},
                        method: 'POST'
                      }, function (err, response, body) {
                          if(err){
                            console.log('error:', err);
                          } else {
                            let result = body;
                            result.showmarks = "user-marks";

                            data.insert(result, function(err, doc) {
                            console.log('Inserted', doc.marks);
                            callback();
                            });
                          }
                    });
                    
                }
                
                
                function attendance(token, callback){
                    request({
                        headers: {
                          'Content-Type': 'application/json; charset=UTF-8',
                          'X-VITASK-API': '98e1e33a8e1964f073d2cc7a5c6bea755e862fe0e9041822e476d3b5b089a6a94f8343faf7b475c54cb1f490b762b8563144b64a914e06d421f8eed9d040ddd2'
                        },
                        uri: attendance_ini_url,
                        json: true,
                        body: {"token" : token},
                        method: 'POST'
                      }, function (err, response, body) {
                          if(err){
                            console.log('error:', err);
                          } else {
                            let result = body;
                            result.classes = "user-attendance";

                            data.insert(result, function(err, doc) {
                            console.log('Inserted', doc.attendance);
                            callback();
                            });
                          }
                    });
                    
                }
                   
            }
    </script>
    

  <!--   Core JS Files   -->
  <script src="assets/js/core/jquery.min.js" type="text/javascript"></script>
  <script src="assets/js/core/popper.min.js" type="text/javascript"></script>
  <script src="assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
  <script src="assets/js/plugins/moment.min.js"></script>
  <!--	Plugin for the Datepicker, full documentation here: https://github.com/Eonasdan/bootstrap-datetimepicker -->
  <script src="assets/js/plugins/bootstrap-datetimepicker.js" type="text/javascript"></script>
  <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
  <script src="assets/js/plugins/nouislider.min.js" type="text/javascript"></script>
  <!--  Google Maps Plugin    -->
  <!-- Control Center for Material Kit: parallax effects, scripts for the example pages etc -->
  <script src="assets/js/material-kit.js?v=2.0.7" type="text/javascript"></script>
</body>

</html>